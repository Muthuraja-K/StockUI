<div class="stock-summary-banner">
  <h2>Stock Summary</h2>
</div>
<div class="stock-summary-wrapper">
  <div class="stock-summary-controls modern-search">
    <!-- Sector Multi-Select -->
    <div class="search-box sector-multi-select">
      <span class="search-icon">🏢</span>
      <div class="sector-chips">
        <ng-container *ngIf="isAllSectorsSelected(); else sectorList">
          <span class="sector-chip selected" (click)="clearFilters()">
            All
          </span>
        </ng-container>
        <ng-template #sectorList>
          <span *ngFor="let sector of sectors" 
                class="sector-chip" 
                [class.selected]="isSectorSelected(sector)"
                (click)="toggleSector(sector)">
            {{ sector }}
          </span>
        </ng-template>
      </div>
    </div>
    
    <!-- Date From Filter -->
    <div class="search-box">
      <span class="search-icon">📅</span>
      <input type="date" [(ngModel)]="dateFrom" (change)="onDateFilterChange()" placeholder="Date From" />
    </div>
    
    <!-- Date To Filter -->
    <div class="search-box">
      <span class="search-icon">📅</span>
      <input type="date" [(ngModel)]="dateTo" (change)="onDateFilterChange()" placeholder="Date To" />
    </div>
    
    <!-- X-Ticker Filter -->
    <div class="checkbox-filter">
      <label class="xticker-checkbox">
        <input type="checkbox" [(ngModel)]="filterIsXticker" (change)="onIsXtickerFilterChange()" [indeterminate]="filterIsXticker === null" />
        <span class="checkbox-label">X-Ticker Only</span>
      </label>
    </div>
    
    <!-- Search Button -->
    <button class="search-btn" 
            (click)="performSearch()" 
            [disabled]="loading"
            aria-label="Search stock summary">
      <span class="search-icon">🔍</span>
      <span class="search-text">{{ loading ? 'Searching...' : 'Search' }}</span>
    </button>

    <!-- Clear All Button -->
    <button *ngIf="selectedSectors.length > 0 || filterIsXticker !== null || dateFrom || dateTo" 
            class="clear-all-btn" 
            (click)="clearFilters()" 
            aria-label="Clear all filters">
      Clear All
    </button>


  </div>

  <!-- Date Range Error Display -->
  <div *ngIf="dateRangeError" class="date-error">
    <span class="error-icon">⚠️</span>
    <span class="error-message">{{ dateRangeError }}</span>
  </div>
  
  <!-- Initial State -->
  <div *ngIf="!hasSearched && !loading" class="initial-state">
    <div class="initial-message">
      <span class="message-icon">📊</span>
      <h3>Ready to Search</h3>
      <p>Configure your filters and click the Search button to view stock summary data.</p>
    </div>
  </div>

  <div *ngIf="loading" class="loading-indicator">Loading...</div>
  
  <!-- Chart View -->
  <div class="chart-container" *ngIf="!loading && viewMode === 'chart' && hasSearched">
    <!-- Chart Header with View Toggle -->
    <div class="chart-header">
      <div class="chart-title">Stock Summary Chart</div>
      <button class="view-toggle-btn" 
              (click)="toggleViewMode()" 
              [disabled]="!hasSearched"
              aria-label="Toggle between grid and chart view">
        <span class="toggle-icon">📋</span>
        <span class="toggle-text">Grid View</span>
      </button>
    </div>
    
    <div *ngIf="sectorGroups.length === 0" class="no-records">No records found</div>
    <div *ngIf="sectorGroups.length > 0" class="chart-wrapper">
      <canvas #chartCanvas width="800" height="400"></canvas>
    </div>
  </div>
  
  <!-- Grid View -->
  <div class="grouped-grid" *ngIf="!loading && viewMode === 'grid' && hasSearched">
    <!-- Grid Header with View Toggle -->
    <div class="grid-header">
      <div class="grid-title">Stock Summary Results</div>
      <button class="view-toggle-btn" 
              (click)="toggleViewMode()" 
              [disabled]="!hasSearched"
              aria-label="Toggle between grid and chart view">
        <span class="toggle-icon">📊</span>
        <span class="toggle-text">Chart View</span>
      </button>
    </div>
    
    <div *ngIf="sectorGroups.length === 0" class="no-records">No records found</div>
    
    <div *ngFor="let group of sectorGroups" class="sector-group">
      <!-- Group Header -->
      <div class="group-header" (click)="toggleGroup(group)">
        <div class="group-info">
          <span class="group-name">{{ group.sector }}</span>
          <span class="group-average" [ngClass]="getPercentageChangeClass(group.averagePercentage)">
            Avg: {{ group.averagePercentage }}
          </span>
        </div>
        <div class="group-toggle">
          <span class="toggle-icon">{{ group.expanded ? '▼' : '▶' }}</span>
          <span class="stock-count">({{ group.stocks.length }} stocks)</span>
        </div>
      </div>
      
      <!-- Group Content -->
      <div class="group-content" *ngIf="group.expanded">
        <table class="stock-table">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Current Price</th>
              <th>{{dateFrom }} Closing Price</th>
              <th>{{dateTo}} Closing Price</th>
              <th>% Change</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let stock of group.stocks">
              <td>{{ stock.ticker }}</td>
              <td>{{ stock.currentPrice }}</td>
              <td>{{ stock.startDateClosePrice }}</td>
              <td>{{ stock.endDateClosePrice }}</td>
              <td>
                <span [ngClass]="getPercentageChangeClass(stock.percentageChange)">
                  {{ stock.percentageChange }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>