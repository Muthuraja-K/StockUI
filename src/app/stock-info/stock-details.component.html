<div class="stock-info-banner">
  <h2>Stock Information</h2>
</div>

<div class="stock-info-table-wrapper">
  <!-- Header Controls -->
  <div class="stock-info-header-controls">
    <div class="left-controls">
      <div class="search-box">
        <span class="search-icon">üè¢</span>
        <select [(ngModel)]="filterSector" class="sector-select" (change)="onSectorFilterChange()">
          <option value="">All Sectors</option>
          <option *ngFor="let sector of sectors" [value]="sector">{{ sector }}</option>
        </select>
        <button *ngIf="filterSector" class="clear-btn" (click)="filterSector=''" aria-label="Clear sector search">&times;</button>
        <span *ngIf="loading" class="filter-loading-spinner">‚ü≥</span>
      </div>
      
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" [(ngModel)]="filterTicker" placeholder="Filter by ticker..." (keyup.enter)="searchStocks()" />
        <button *ngIf="filterTicker" class="clear-btn" (click)="filterTicker=''" aria-label="Clear ticker search">&times;</button>
        <span *ngIf="loading" class="filter-loading-spinner">‚ü≥</span>
      </div>
      
      <div class="leverage-filter">
        <label>Leverage:</label>
        <select [(ngModel)]="leverageFilter" (change)="onLeverageFilterChange()">
          <option *ngFor="let option of leverageOptions" [value]="option">{{ option }}</option>
        </select>
        <span *ngIf="loading" class="filter-loading-spinner">‚ü≥</span>
      </div>
    </div>
    
    <div class="right-controls">
      <div class="refresh-controls">
        <label>Refresh:</label>
        <select [(ngModel)]="refreshInterval" (change)="onRefreshIntervalChange()">
          <option *ngFor="let option of refreshOptions" [value]="option">{{ option }}</option>
        </select>
        <button 
          class="refresh-btn" 
          [class.active]="isAutoRefreshEnabled"
          (click)="toggleAutoRefresh()"
          [title]="isAutoRefreshEnabled ? 'Stop Auto Refresh' : 'Start Auto Refresh'">
          {{ isAutoRefreshEnabled ? '‚èπÔ∏è' : 'üîÑ' }}
        </button>
        <button class="update-btn" (click)="updateTickerData()" title="Update Ticker Data" [disabled]="loading">
          <span *ngIf="loading" class="btn-loading-spinner">‚ü≥</span>
          üìä
        </button>
      </div>
      
      <button class="search-btn" (click)="searchStocks()" aria-label="Search stocks" [disabled]="loading">
        <span *ngIf="loading" class="btn-loading-spinner">‚ü≥</span>
        Search
      </button>
      <button *ngIf="filterTicker || filterSector || leverageFilter !== 'Ticker Only'" class="clear-all-btn" (click)="clearFilters()" aria-label="Clear all filters" [disabled]="loading">
        <span *ngIf="loading" class="btn-loading-spinner">‚ü≥</span>
        Clear All
      </button>
    </div>
  </div>

  <div *ngIf="loading && stocks.length === 0" class="loading-indicator">Loading...</div>
  
  <!-- Enhanced Stock Table -->
  <table class="stock-info-table finviz-style" *ngIf="stocks.length > 0">
    <thead>
      <tr>
        <th class="sortable-header" (click)="sortByColumn('ticker')">
          Ticker {{ getSortIcon('ticker') }}
          <span *ngIf="isSorting('ticker')" class="sorting-spinner">‚ü≥</span>
        </th>
        <th>Sector</th>
        <th class="sortable-header" (click)="sortByColumn('market_cap')">
          Market Cap {{ getSortIcon('market_cap') }}
          <span *ngIf="isSorting('market_cap')" class="sorting-spinner">‚ü≥</span>
        </th>
        <th class="sortable-header" (click)="sortByColumn('earning_date')">
          Earnings {{ getSortIcon('earning_date') }}
          <span *ngIf="isSorting('earning_date')" class="sorting-spinner">‚ü≥</span>
        </th>
        <th class="sortable-header" (click)="sortByColumn('current_price')">
          Price {{ getSortIcon('current_price') }}
          <span *ngIf="isSorting('current_price')" class="sorting-spinner">‚ü≥</span>
        </th>
        <th class="sortable-header" (click)="sortByColumn('ah_percentage')">
          AH% {{ getSortIcon('ah_percentage') }}
          <span *ngIf="isSorting('ah_percentage')" class="sorting-spinner">‚ü≥</span>
        </th>
        <th class="sortable-header" (click)="sortByColumn('today_percentage')">
          Today {{ getSortIcon('today_percentage') }}
          <span *ngIf="isSorting('today_percentage')" class="sorting-spinner">‚ü≥</span>
        </th>
        <th class="sortable-header" (click)="sortByColumn('previous_day_percentage')">
          1D {{ getSortIcon('previous_day_percentage') }}
          <span *ngIf="isSorting('previous_day_percentage')" class="sorting-spinner">‚ü≥</span>
        </th>
        <th class="sortable-header" (click)="sortByColumn('five_day_percentage')">
          5D {{ getSortIcon('five_day_percentage') }}
          <span *ngIf="isSorting('five_day_percentage')" class="sorting-spinner">‚ü≥</span>
        </th>
        <th class="sortable-header" (click)="sortByColumn('one_month_percentage')">
          1M {{ getSortIcon('one_month_percentage') }}
          <span *ngIf="isSorting('one_month_percentage')" class="sorting-spinner">‚ü≥</span>
        </th>
        <th class="sortable-header" (click)="sortByColumn('six_month_percentage')">
          6M {{ getSortIcon('six_month_percentage') }}
          <span *ngIf="isSorting('six_month_percentage')" class="sorting-spinner">‚ü≥</span>
        </th>
        <th class="sortable-header" (click)="sortByColumn('one_year_percentage')">
          1Y {{ getSortIcon('one_year_percentage') }}
          <span *ngIf="isSorting('one_year_percentage')" class="sorting-spinner">‚ü≥</span>
        </th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let stock of stocks" class="stock-row">
        <td class="ticker-cell">
          <span class="clickable-ticker" (click)="showSentiment(stock.ticker)">
            {{ stock.ticker }}
            <span *ngIf="stock.isxticker" class="leverage-badge">L</span>
          </span>
        </td>
        <td class="sector-cell">
          <span class="sector-text">{{ stock.sector }}</span>
        </td>
        <td class="market-cap-cell">{{ stock.market_cap }}</td>
        <td class="earnings-cell">{{ stock.earning_date }}</td>
        <td class="price-cell">{{ getCurrentPrice(stock) }}</td>
        <td class="percentage-cell">
          <span [ngClass]="getPercentageChangeClass(getAhPercentage(stock))">{{ getAhPercentage(stock) }}</span>
        </td>
        <td class="change-cell">
          <div class="change-info">
            <span [ngClass]="getPercentageChangeClass(getTodayChange(stock))">{{ getTodayChange(stock) }}</span>
             <div class="range-info">
              <span class="low">L: {{ stock.today.low }}</span>
              <span class="high">H: {{ stock.today.high }}</span>
            </div>
          </div>
        </td>
        <td class="change-cell">
          <div class="change-info">
            <span [ngClass]="getPercentageChangeClass(stock.previous_day.percentage)">{{ stock.previous_day.percentage }}</span>
            <div class="range-info">
              <span class="low">L: {{ stock.previous_day.low }}</span>
              <span class="high">H: {{ stock.previous_day.high }}</span>
            </div>
          </div>
        </td>
        <td class="change-cell">
          <div class="change-info">
            <span [ngClass]="getPercentageChangeClass(stock.five_day.percentage)">{{ stock.five_day.percentage }}</span>
            <div class="range-info">
              <span class="low">L: {{ stock.five_day.low }}</span>
              <span class="high">H: {{ stock.five_day.high }}</span>
            </div>
          </div>
        </td>
        <td class="change-cell">
          <div class="change-info">
            <span [ngClass]="getPercentageChangeClass(stock.one_month.percentage)">{{ stock.one_month.percentage }}</span>
            <div class="range-info">
              <span class="low">L: {{ stock.one_month.low }}</span>
              <span class="high">H: {{ stock.one_month.high }}</span>
            </div>
          </div>
        </td>
        <td class="change-cell">
          <div class="change-info">
            <span [ngClass]="getPercentageChangeClass(stock.six_month.percentage)">{{ stock.six_month.percentage }}</span>
            <div class="range-info">
              <span class="low">L: {{ stock.six_month.low }}</span>
              <span class="high">H: {{ stock.six_month.high }}</span>
            </div>
          </div>
        </td>
        <td class="change-cell">
          <div class="change-info">
            <span [ngClass]="getPercentageChangeClass(stock.one_year.percentage)">{{ stock.one_year.percentage }}</span>
            <div class="range-info">
              <span class="low">L: {{ stock.one_year.low }}</span>
              <span class="high">H: {{ stock.one_year.high }}</span>
            </div>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
  
  <!-- End of data indicator -->
  <div *ngIf="stocks.length > 0" class="end-of-data">
    All records loaded ({{ totalRecords }} total)
  </div>
  
  <!-- No records found -->
  <div *ngIf="!loading && stocks.length === 0" class="no-records">
    No records found
  </div>
</div>

<!-- Sentiment Modal -->
<div class="modal-backdrop" *ngIf="showSentimentModal" (click)="closeSentimentModal()">
  <div class="sentiment-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Sentiment Analysis - {{ sentimentData?.ticker }}</h3>
      <button class="close-btn" (click)="closeSentimentModal()">&times;</button>
    </div>
    
    <div class="modal-content" *ngIf="!sentimentLoading && sentimentData">
      <!-- Overall Sentiment -->
      <div class="sentiment-section">
        <h4>Overall Sentiment</h4>
        <div class="overall-sentiment">
          <span class="sentiment-badge" [ngClass]="getSentimentClass(sentimentData.overall_sentiment)">
            {{ getSentimentIcon(sentimentData.overall_sentiment) }} {{ sentimentData.overall_sentiment }}
          </span>
          <div class="sentiment-score">
            Score: {{ (sentimentData.sentiment_score * 100).toFixed(1) }}%
          </div>
        </div>
      </div>

      <!-- Sentiment Distribution -->
      <div class="sentiment-section">
        <h4>Sentiment Distribution</h4>
        <div class="sentiment-distribution">
          <div class="sentiment-bar">
            <div class="bar-label">Positive</div>
            <div class="bar-container">
              <div class="bar-fill positive" [style.width.%]="sentimentData.positive_percentage"></div>
              <span class="bar-text">{{ sentimentData.positive_percentage }}%</span>
            </div>
          </div>
          <div class="sentiment-bar">
            <div class="bar-label">Neutral</div>
            <div class="bar-container">
              <div class="bar-fill neutral" [style.width.%]="sentimentData.neutral_percentage"></div>
              <span class="bar-text">{{ sentimentData.neutral_percentage }}%</span>
            </div>
          </div>
          <div class="sentiment-bar">
            <div class="bar-label">Negative</div>
            <div class="bar-container">
              <div class="bar-fill negative" [style.width.%]="sentimentData.negative_percentage"></div>
              <span class="bar-text">{{ sentimentData.negative_percentage }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Social Media Sentiment -->
      <div class="sentiment-section">
        <h4>Social Media Sentiment</h4>
        <div class="social-sentiment">
          <div class="social-item">
            <span class="social-label">Twitter:</span>
            <span class="sentiment-badge" [ngClass]="getSentimentClass(sentimentData.social_media_sentiment.twitter_sentiment)">
              {{ getSentimentIcon(sentimentData.social_media_sentiment.twitter_sentiment) }} {{ sentimentData.social_media_sentiment.twitter_sentiment }}
            </span>
          </div>
          <div class="social-item">
            <span class="social-label">Reddit:</span>
            <span class="sentiment-badge" [ngClass]="getSentimentClass(sentimentData.social_media_sentiment.reddit_sentiment)">
              {{ getSentimentIcon(sentimentData.social_media_sentiment.reddit_sentiment) }} {{ sentimentData.social_media_sentiment.reddit_sentiment }}
            </span>
          </div>
          <div class="social-item">
            <span class="social-label">Overall Social Score:</span>
            <span class="score-value">{{ (sentimentData.social_media_sentiment.overall_social_score * 100).toFixed(1) }}%</span>
          </div>
        </div>
      </div>

      <!-- Technical Indicators -->
      <div class="sentiment-section">
        <h4>Technical Indicators</h4>
        <div class="technical-indicators">
          <div class="indicator-item">
            <span class="indicator-label">RSI:</span>
            <span class="indicator-value">{{ sentimentData.technical_indicators.rsi }}</span>
          </div>
          <div class="indicator-item">
            <span class="indicator-label">MACD:</span>
            <span class="indicator-value">{{ sentimentData.technical_indicators.macd }}</span>
          </div>
          <div class="indicator-item">
            <span class="indicator-label">Moving Averages:</span>
            <span class="indicator-value">{{ sentimentData.technical_indicators.moving_averages }}</span>
          </div>
          <div class="indicator-item">
            <span class="indicator-label">Support Level:</span>
            <span class="indicator-value">${{ sentimentData.technical_indicators.support_level }}</span>
          </div>
          <div class="indicator-item">
            <span class="indicator-label">Resistance Level:</span>
            <span class="indicator-value">${{ sentimentData.technical_indicators.resistance_level }}</span>
          </div>
        </div>
      </div>

      <!-- Recent News -->
      <div class="sentiment-section">
        <h4>Recent News ({{ sentimentData.news_count }} articles analyzed)</h4>
        <div class="recent-news">
          <div class="news-item" *ngFor="let news of sentimentData.recent_news">
            <div class="news-header">
              <span class="sentiment-badge small" [ngClass]="getSentimentClass(news.sentiment)">
                {{ getSentimentIcon(news.sentiment) }} {{ news.sentiment }}
              </span>
              <span class="news-date">{{ news.published_date }}</span>
            </div>
            <div class="news-title">{{ news.title }}</div>
            <div class="news-source">{{ news.source }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="loading-content" *ngIf="sentimentLoading">
      <div class="loading-spinner"></div>
      <p>Analyzing sentiment data...</p>
    </div>
  </div>
</div> 