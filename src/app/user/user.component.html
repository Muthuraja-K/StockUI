<div class="user-management">
  <div class="user-banner">
    <h2>{{ getPageTitle() }}</h2>
    <p class="page-description">{{ getPageDescription() }}</p>
  </div>

  <div class="user-table-wrapper">
    <!-- Header Controls - Only show for admin users -->
    @if (canSeeAllUsers) {
      <div class="user-header-controls">
        <div class="left-controls">
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" [(ngModel)]="filterUsername" placeholder="Filter by username..." (keyup.enter)="searchUsers()" />
            @if (filterUsername) {
              <button class="clear-btn" (click)="filterUsername=''" aria-label="Clear username search">&times;</button>
            }
          </div>
        </div>
        
        <div class="right-controls">
          <button class="search-btn" (click)="searchUsers()" aria-label="Search users">
            Search
          </button>
          @if (filterUsername) {
            <button class="clear-all-btn" (click)="clearFilter()" aria-label="Clear all filters">
              Clear All
            </button>
          }
          @if (canAddUsers) {
            <button class="btn btn-primary" (click)="showAddForm()">Add New User</button>
          }
        </div>
      </div>
    }

    <!-- User Profile View for Regular Users -->
    @if (!canSeeAllUsers && !loading) {
      <div class="user-profile-view">
        <div class="profile-card">
          <div class="profile-header">
            <h3>My Profile</h3>
          </div>
          <div class="profile-content">
            <div class="profile-field">
              <label>Username:</label>
              <span>{{ currentUser?.username }}</span>
            </div>
            <div class="profile-field">
              <label>Role:</label>
              <span class="role-badge" [ngClass]="getRoleClass(currentUser?.role || 'user')">
                {{ currentUser?.role }}
              </span>
            </div>
            <div class="profile-field">
              <label>First Name:</label>
              <span>{{ currentUser?.firstname || 'N/A' }}</span>
            </div>
            <div class="profile-field">
              <label>Last Name:</label>
              <span>{{ currentUser?.lastname || 'N/A' }}</span>
            </div>
            <div class="profile-actions">
                          @if (currentUser) {
              <button class="btn btn-primary" (click)="showEditForm(currentUser)">
                Edit Profile
              </button>
            }
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Users Table - Only show for admin users -->
    @if (canSeeAllUsers && !loading) {
      <div class="users-table">
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>Username</th>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (user of users; track user.username) {
              <tr>
              <td>{{ user.username }}</td>
              <td>{{ user.firstname || 'N/A' }}</td>
              <td>{{ user.lastname || 'N/A' }}</td>
              <td>
                <span class="role-badge" [ngClass]="getRoleClass(user.role)">
                  {{ user.role }}
                </span>
              </td>
              <td>
                <div class="action-buttons">
                  @if (canEditUser(user)) {
                    <button class="btn-icon btn-edit" (click)="showEditForm(user)" title="Edit User">
                      <i class="fas fa-edit"></i>
                    </button>
                  }
                  @if (canDeleteUser(user)) {
                    <button class="btn-icon btn-delete" (click)="deleteUser(user.username)" title="Delete User">
                      <i class="fas fa-trash"></i>
                    </button>
                  }
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>

  @if (loading) {
    <div class="loading">
      <p>Loading users...</p>
    </div>
  }

  <!-- Add User Form - Only show for admin users -->
  @if (showAddUserForm && canAddUsers) {
    <div class="modal">
      <div class="modal-content">
        <h3>Add New User</h3>
        <form (ngSubmit)="addUser()">
          <div class="form-group">
            <label>Username *</label>
            <input type="text" [(ngModel)]="newUser.username" name="username" required>
          </div>
          <div class="form-group">
            <label>Password *</label>
            <input type="password" [(ngModel)]="newUser.password" name="password" required>
          </div>
          <div class="form-group">
            <label>Role</label>
            @if (canChangeRole) {
              <select [(ngModel)]="newUser.role" name="role">
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
            }
            @if (!canChangeRole) {
              <input type="text" [value]="newUser.role" readonly>
            }
          </div>
          <div class="form-group">
            <label>First Name</label>
            <input type="text" [(ngModel)]="newUser.firstname" name="firstname">
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" [(ngModel)]="newUser.lastname" name="lastname">
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Add User</button>
            <button type="button" class="btn btn-secondary" (click)="hideForms()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Edit User Form -->
  @if (showEditUserForm) {
    <div class="modal">
      <div class="modal-content">
        <h3>Edit User: {{ selectedUser?.username }}</h3>
        <form (ngSubmit)="updateUser()">
          <div class="form-group">
            <label>Username *</label>
            <input type="text" [(ngModel)]="editUser.username" name="username" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" [(ngModel)]="editUser.password" name="password" placeholder="Leave blank to keep current">
          </div>
          <div class="form-group">
            <label>Role</label>
            @if (canChangeRole) {
              <select [(ngModel)]="editUser.role" name="role">
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
            }
            @if (!canChangeRole) {
              <input type="text" [value]="editUser.role" readonly>
            }
          </div>
          <div class="form-group">
            <label>First Name</label>
            <input type="text" [(ngModel)]="editUser.firstname" name="firstname">
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" [(ngModel)]="editUser.lastname" name="lastname">
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Update User</button>
            <button type="button" class="btn btn-secondary" (click)="hideForms()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Custom Confirm Modal -->
  @if (showConfirmModal) {
    <div class="modal-overlay" (click)="closeConfirmModal()">
      <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ confirmTitle }}</h3>
          <button class="close-btn" (click)="closeConfirmModal()">&times;</button>
        </div>
        <div class="modal-body">
          <p>{{ confirmMessage }}</p>
        </div>
        <div class="modal-actions">
          <button class="btn btn-danger" (click)="confirmAction()">Confirm</button>
          <button class="btn btn-secondary" (click)="closeConfirmModal()">Cancel</button>
        </div>
      </div>
    </div>
  }

  <!-- Custom Success Modal -->
  @if (showSuccessModal) {
    <div class="modal-overlay" (click)="closeSuccessModal()">
      <div class="modal-content success-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚úÖ {{ successTitle }}</h3>
          <button class="close-btn" (click)="closeSuccessModal()">&times;</button>
        </div>
        <div class="modal-body">
          <p>{{ successMessage }}</p>
        </div>
        <div class="modal-actions">
          <button class="btn btn-primary" (click)="closeSuccessModal()">OK</button>
        </div>
      </div>
    </div>
  }

  <!-- Custom Error Modal -->
  @if (showErrorModal) {
    <div class="modal-overlay" (click)="closeErrorModal()">
      <div class="modal-content error-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚ùå {{ errorTitle }}</h3>
          <button class="close-btn" (click)="closeErrorModal()">&times;</button>
        </div>
        <div class="modal-body">
          <p>{{ errorMessage }}</p>
        </div>
        <div class="modal-actions">
          <button class="btn btn-primary" (click)="closeErrorModal()">OK</button>
        </div>
      </div>
    </div>
  }
</div>
